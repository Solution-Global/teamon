<div class="modal-dialog">
	<div class="middle-box text-center loginscreen animated fadeInDown">
		<div class="sk-spinner sk-spinner-rotating-plane" style="display:none"></div>
    <div>
      <h3>Welcome to TEAMON</h3>
      <p>Login in. To see it in action.</p>
      <form role="form" id="login-form">
          <div class="form-group">
              <input name="email" type="email" class="form-control" placeholder="Enter Email"/>
          </div>
          <div class="form-group">
              <input name="password" type="password" class="form-control" placeholder="Password"/>
          </div>
					<div class="form-group">
              <label><input id="keepMe" name="keepMe" type="checkbox" class="i-checks" /> Keep me signed in </label>
          </div>
          <button type="submit" class="btn btn-primary block full-width m-b">Login</button>
					<a class="btn btn-sm btn-white btn-block" id="onRegisterEmplModal">Create an account</a>
          <a href="#" id="forgot-password"><small>Forgot password?</small></a>
      </form>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
	// set validation for login Form
	$("#login-form").validate({
		rules: {
			email: {
				required: true
			},
			password: {
				required: true
			}
		}
	});

	$("#login-form").delegate('#forgot-password', 'click touchend', function() {
		toastr.info("Ask to dev1.solution@uangel.com to reset password");
	})
	// set event for login action
	$('#login-form').submit(function(event) {
		event.preventDefault();

		var $loginAlert = $("#login-alert").addClass("hide");
		if(!$(this).valid())
			return;

		// get user agent information
		var uaParser = new UAParser();
		uaParser.setUA(navigator.userAgent);
		var os = uaParser.getOS().name + (uaParser.getOS().name === "Windows" ? uaParser.getOS().version : "");
		var browser = uaParser.getBrowser().name + (uaParser.getBrowser().name === "IE" ? uaParser.getBrowser().major : "");
		var device = uaParser.getDevice().model == undefined ? runningChannel === 'APP' ? 'Desktop': '' : uaParser.getDevice().model;

		var params = $(this).serializeObject();
		params.team = "uangel";
		params.os = os;
		params.browser = browser;
		params.device = device;
		params.client = runningChannel;

		restResource.login.login(params, function(data, error) {
			// show block screen
			$("#login-form").parent().hide();
			$(".sk-spinner").show();

			// set the personal pref info first to use it around the app.
			myPreference = new preferenceManager(localStorageManager, data.emplId); // init preference
			var isAlreadyLogin = loginInfo ? true : false;
			loginInfo = {
	      "email": data.email,
				"emplId": data.emplId ? Number(data.emplId) : null,
				"authKey": data.authKey,
	      "teamId": data.teamId ? Number(data.teamId) : null,
				"name": data.name,
				"browser": browser,
				"os": os,
				"device": device,
				"photoLoc": data.photoLoc
	    };

			configureCertifiedAPI(data.email, data.authKey);

			if(params.keepMe)
				localStorageManager.setValue("keepEmplId", data.emplId);
			else
				localStorageManager.removeKey("keepEmplId");

			myPreference.setPreference("teamId", data.teamId);
			myPreference.setPreference("email", data.email);
			myPreference.setPreference("authKey", data.authKey);
			myPreference.setPreference("emplId", data.emplId);
			myPreference.setPreference("name", data.name);
			myPreference.setPreference("photoLoc", data.photoLoc);

			sessionStorageManager.setValue("sessionEmplId", data.emplId);

			// do all the background job before show whole screen element
			// here's the function chain starts
			// FIXME there must be a better way to solve function chain
			_loadUserList();

			chatModule.configMyInfo(loginInfo.teamId, loginInfo.emplId);

			params = null;
		});

		function _loadUserList() {
			var params = {
				"teamId": loginInfo.teamId,
				"limit" : constants.COMMON_SEARCH_ALL
			};
			restResource.empl.getListByTeamId(params, function(data) {
				if (data.rows) {
					$.each(data.rows, function(idx, row) {
						 userCache.set(row.emplId, row); // add each employee into userCache.
					});

					// callback
					_loadOnlineUserList();
				}
			});
		}

		// load online user list and set it online on userCache
		function _loadOnlineUserList() {
			restResource.login.getLoggedInEmplListByTeamId({ "teamId": loginInfo.teamId }, function(data) {
				if(data) {
					$.each(data, function() {
						userCache.get(this.emplId).online = true;
					});
				}

				// callback
				_syncChatMessage();
			});
		}

		function _syncChatMessage() {
			loadAllArea();
			myMessage.syncChatMessage(constants.DIRECT_CHAT, userCache.getValueArray(), function() {
				// close login dialog when sync finished
				$('#login-form').closest(".modal-dialog").closest(".modal").modal("hide");
			});
		}

	});

	$('#onRegisterEmplModal').click(function() {
		openModalDialog("/user/register_empl_popup.html");
	});
});
</script>
