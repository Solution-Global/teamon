<div class="ibox nopadding">
  <div class="ibox-title">
    <h5 class="title">Search Results</h5>
    <div class="ibox-tools">
      <a class="aside-close-link" onclick="hideInformationArea();">
      <i class="fa fa-times"></i>
      </a>
    </div>
  </div>
  <div class="ibox-content nopadding information-list search-list">
    <ul>
      <input type="hidden" name="hidden-keyword" value=""/>
      <script id="searchlist-template" type="text/template">
        <a id="chat-room-name" href="#" style="padding-left: 15px;">{{chatRoomName}}</a>
        <div id="chat-{{chatId}}" class="chat-message left" data-date="{{date}}">
          <img class="message-avatar" src="{{img}}" alt="{{imgAlt}}" style="float: left; margin-right: 10px;">
          <div class="message" style="text-align: left; margin-left: 55px;">
            <a class="about-user" href="#" data-emplid='{{emplId}}'>{{sender}}</a>
            <span class="message-date">{{date}}  {{time}}</span>
            <span class="message-content">
              {{{msgText}}}
            </span>
          </div>
          <input type="hidden" name="hidden-chatId" value="{{chatId}}" />
          <input type="hidden" name="hidden-topic" value="{{topic}}" />
          <input type="hidden" name="hidden-name" value="{{chatRoomName}}" />
          <input type="hidden" name="hidden-emplId" value="{{emplId}}" />
        </div>
        <div class="hr-line-dashed"></div>
      </script>
    </ul>
  </div>
</div>
<script>
$(document).ready(function() {
  var $informationSec = $("#information-section");
  $("#information-section").find(".search-list ul").on("click", "#chat-room-name", function(event) {
    event.preventDefault();
    var topic = $(this).next().nameFind("hidden-topic").val();
    var chatType = getChatType(topic);
    if (chatType === constants.DIRECT_CHAT) {
      activeChatInfo = {
        "topic" : topic,
        "name" : $(this).next().nameFind("hidden-name").val(),
        "emplId" : $(this).next().nameFind("hidden-emplId").val()
      }
    } else if (chatType === constants.CHANNEL_CHAT) {
      var channelList = channelCache.getValueArray();
      for(var key in channelList) {
        if (loginInfo.teamId == channelList[key].teamId && topic == channelList[key].name && 'A' == channelList[key].dbStat) {
          activeChatInfo = {
            "topic" : topic,
            "name" : topic,
            "channelId" : channelList[key].channelId
          }
          break;
        }
      }
    }

    hideCallArea();
    hideScreenShareArea();

    showChatArea();
    changeChatView(false);

    var chatId = $(this).next().nameFind("hidden-chatId").val();
    scrollToMessage(chatId, true);
  });

  $informationSec.find(".search-list").mCustomScrollbar({
    axis:"y",
    theme:"inset-2-dark",
    callbacks:{
      onTotalScroll:function(){
        doScrollSearch();
      }
    }
  });
});

function scrollToMessage(chatId) {
  var $chatSec = $("#chat-section");
  var $contentArea = $chatSec.find(".content_area");

  $contentArea.mCustomScrollbar("scrollTo", "#chat-" + chatId);
  $contentArea.find("#chat-" + chatId).css("border-radius", "3px");
  $contentArea.find("#chat-" + chatId).addClass("animated myshake");
};

var scrollSearchCount = 0;
function doScrollSearch() {
  scrollSearchCount++;
  var limit = 10;
  var offset = scrollSearchCount * limit;

  var params = {
    "top-search": $("#information-section").nameFind("hidden-keyword").val(),
    "teamId": loginInfo.teamId,
    "emplId": loginInfo.emplId,
    "limit": limit,
    "offset": offset
  };

  restResource.chat.getListByKeyword(params, function(data) {
    var $informationSec = $("#information-section");
    var $searchListArea = $("#information-section").find(".search-list ul");
    var searchMsgTemplate = $informationSec.find("#searchlist-template").html();

    if (data != null && data.length > 0) {
      $.each(data, function(idx, message) {
        var senderInfo = userCache.get(message.senderId);
        var sender = "unknown";
        if(senderInfo)
          sender = senderInfo.name;
        var imagePath = "../img/profile_no.jpg";
        if(runningChannel === constants.CHANNEL_APP) {
          if (senderInfo.photoLoc != null) {
            imagePath = constants.IMAGE_URL + senderInfo.photoLoc + "?teamId=" + senderInfo.teamId + "&topic=profile_image&emplId=" + senderInfo.emplId + "&type=profile";
          }
          else {
            imagePath = "file://" + path.join(__dirname, './img/profile_no.jpg');
          }
        } else {
          if (senderInfo.photoLoc != null) {
            imagePath = constants.IMAGE_URL + senderInfo.photoLoc + "?teamId=" + senderInfo.teamId + "&topic=profile_image&emplId=" + senderInfo.emplId + "&type=profile";
          }
          else {
            imagePath = imagePath;
          }
        }

        var emplId;
        var chatRoomName;
        var chatType = getChatType(message.topic);
        if (chatType === constants.DIRECT_CHAT) {
          chatRoomName = "@";
          if (loginInfo.emplId === message.senderId) {
            emplId = message.recevierId;
            chatRoomName += userCache.get(message.receiverId).name;
          } else {
            emplId = message.senderId;
            chatRoomName += userCache.get(message.senderId).name;
          }
        } else if (chatType === constants.CHANNEL_CHAT) {
          chatRoomName = message.topic;
        }

        var messageData = {
          "chatId": message.chatId,
          "topic": message.topic,
          "date": new Date(message.creTime).format("YYYY/MM/DD"),
          "img": imagePath,
          "imgAlt": sender,
          "sender": sender,
          "time": new Date(message.creTime).format("A hh:mm"),
          "msgText": message.msg,
          "chatRoomName": chatRoomName,
          "emplId": emplId
        };

        $searchListArea.append(Mustache.render(searchMsgTemplate, messageData));
      });
    } else {
      if ($searchListArea.find("#return-msg").length) {
        $searchListArea.find("#return-msg").remove();
      }
      $searchListArea.append("<div id='return-msg' style='text-align: center;'><span>No more messages found</span></div>");
    }
  });
}
</script>
