<div class="modal-dialog">
  <div class="modal-content animated bounceInRight">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
      <i class="fa fa-github-alt modal-icon"></i>
      <h4 class="modal-title">invite others to this channel </h4>
    </div>
    <div class="modal-body">
      <div class="row">
        <div>
          <form role="form" id="inviteChannelForm" onsubmit="return false;">
            <div class="form-group">
              <label>Invite others</label>
              <div class="input-group col-sm-12">
                <select data-placeholder="Choose users..." class="chosen-select" name="members" multiple tabindex="4">
                </select>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
      <button type="button" id="invite-channel-submit" class="btn btn-primary" type="submit">Invite</button>
    </div>
  </div>
</div>
<script>
$(document).ready(function() {
  var $inviteChannelForm = $("#inviteChannelForm");
  var channelId = activeChatInfo.channelId;
  var channelValue = channelCache.get(channelId);
  var existMembers;
  for (var key in channelValue.memberList) {
    var emplId = channelValue.memberList[key].emplId;
    if (!existMembers)
      existMembers = emplId;
    else
      existMembers += "," + channelValue.memberList[key].emplId;
  }
  var membersArray = String(existMembers).split(",");
  var chosenSelect = $inviteChannelForm.find(".chosen-select");
  var userArray = userCache.getValueArray();
  for (var key in userArray) {
    var userValue = userArray[key];
    var isMember = membersArray.indexOf(String(userValue.emplId));
    if (isMember < 0)
      chosenSelect.append("<option value='" + userValue.emplId + "'>" + userValue.name + "</option>");
  }
  chosenSelect.chosen({width:"100%"});

  // set event for new create channel
  $("#invite-channel-submit").bind("click", function() {
    var newMembers = $inviteChannelForm.find("[name=members]").val();
    var params = {
      "channelId": channelId,
      "members": newMembers,
    };

    restResource.channel.addMember(params,
      function(response) {
        // 새로운 추가운 사용자 대상으로 그룹 가입 권고
        var paramsForNewMember = {
          "type": constants.CHANNEL_CREATE,
          "teamId" : loginInfo.teamId,
          "topic" : activeChatInfo.topic
        };

        var names = "";
        for (var key in newMembers) {
          chatModule.sendCommand(newMembers[key], paramsForNewMember);
          var memberInfo = userCache.get(newMembers[key]);
          names += " " + memberInfo.name;
        }

        // 기존 사용자에게 멤버 추가
        var paramsForExistMember = {
          "type": constants.CHANNEL_ADD_MEMBER,
          "channelId": channelId,
          "topic" : activeChatInfo.topic,
          "newMembers": newMembers
        }

        for (var key in membersArray) {
          chatModule.sendCommand(membersArray[key], paramsForExistMember);
        }

        chatModule.sendMsg(activeChatInfo.topic, "Invite members - " + names); // 멤버 추가 메시지 전송

        // form reset
        $inviteChannelForm.each(function() {
          if (this.className  == "frmClass") this.reset();
        });
        $inviteChannelForm.closest(".modal-dialog").closest(".modal").modal("hide");
      }
    );
  });
});
</script>
