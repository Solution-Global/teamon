<div id="header-section" class="navbar-header">
  <a class="navbar-minimalize minimalize-styl-2 btn btn-primary" href="#"><i class="fa fa-bars"></i></a>
  <form id="searchForm" role="search" class="navbar-form-custom" action="#">
      <div class="form-group">
          <input type="text" placeholder="Search for something..." class="form-control" name="top-search" id="top-search">
      </div>
  </form>
</div>
<ul class="nav navbar-top-links navbar-right">
  <li>
    <a href="#"><i class="mention fa fa-at fa-lg"></i></a>
  </li>
  <!--
  // TODO 즐겨 찾기 추가 개발 필요
  <li>
    <a href="#"><i class="fa fa-star-o fa-lg"></i></a>
  </li>
  -->
  <li>
    <a class="dropdown-toggle" data-toggle="dropdown" href="#"><i class="fa fa-list fa-lg"></i></a>
    <ul class="dropdown-menu dropdown-user">
      <li><a href="#" id="info-about">About...</a></li>
      <li><a href="#" id="info-file">Files</a></li>
      <!--<li><a href="#">Help</a></li>00-->
    </ul>
  </li>
</ul>
<script>
$(document).ready(function() {
  var $headerSec = $("#header-section");
  var $titleArea = $headerSec.find(".title_area");
  var $title = $headerSec.find(".tit");

  setHearderTitle = function(text) {
    $title.html(text);
    // show about menu
    setAboutLabel();
  }

  if (activeChatInfo === null) {
     $("#info-about").hide();
  }

  //bind events
  $headerSec.find(".mention").click(function() {
    setInfoSectionFlag(true);
    showInformationArea(constants.INFO_AREA_MENTION);
  });

  $("#info-about").click(function() {
    setInfoSectionFlag(true);
    if (activeChatInfo.channelId != null)
      showInformationArea(constants.INFO_AREA_ABOUT_CHANNEL);
    else if (activeChatInfo.name != null)
      showInformationArea(constants.INFO_AREA_ABOUT_USER);
  })

  $("#info-file").click(function() {
    setInfoSectionFlag(true);
    showInformationArea("file_list.html");
  })

  $("#searchForm").submit(function(event) {
    event.preventDefault();
    if (!$(this).valid())
      return;

    var params = $(this).serializeObject();
    params.teamId = loginInfo.teamId;
    params.emplId = loginInfo.emplId;
    params.limit = 10;
    params.offset = 0;
    doSearch(params);
  });

    // toggle menu
    $('.navbar-minimalize').on("touchend click", switchMenu);
    function switchMenu() {
      if ($('body').hasClass('body-small')) {
        $('body').toggleClass('small-navbar');
      } else {
        if (!$('body').hasClass('small-navbar')) {
          $('body').toggleClass('no-menu');
        }
      }
    }
});

function setAboutLabel() {
  var $infoAbout = $("#info-about");
  $infoAbout.show();
  if (activeChatInfo.channelId != null)
    $infoAbout.html("About Channel");
  else if (activeChatInfo.name != null)
    $infoAbout.html("About User");
}

function doSearch(params) {
  if (params["top-search"] === undefined) {
    toastr.warning("Please enter your keyword.");
    return;
  }

  restResource.chat.getListByKeyword(params, function(data) {
    var $informationSec = $("#information-section");
    var $searchListArea = $informationSec.find(".search-list ul");
    var searchListTemplate = $informationSec.find("#searchlist-template").html();

    if (data != null && data.length > 0) {
      $.each(data, function(idx, message) {
        var senderInfo = userCache.get(message.senderId);
        var sender = "unknown";
        if(senderInfo)
          sender = senderInfo.name;
        var imagePath = "../img/profile_no.jpg";
        if(runningChannel === constants.CHANNEL_APP) {
          if (senderInfo.photoLoc != null) {
            imagePath = constants.IMAGE_URL + senderInfo.photoLoc + "?teamId=" + senderInfo.teamId + "&topic=profile_image&emplId=" + senderInfo.emplId + "&type=profile";
          }
          else {
            imagePath = "file://" + path.join(__dirname, './img/profile_no.jpg');
          }
        } else {
          if (senderInfo.photoLoc != null) {
            imagePath = constants.IMAGE_URL + senderInfo.photoLoc + "?teamId=" + senderInfo.teamId + "&topic=profile_image&emplId=" + senderInfo.emplId + "&type=profile";
          }
          else {
            imagePath = imagePath;
          }
        }

        var emplId;
        var chatRoomName;
        var chatType = getChatType(message.topic);
        if (chatType === constants.DIRECT_CHAT) {
          chatRoomName = "@";
          if (loginInfo.emplId === message.senderId) {
            emplId = message.recevierId;
            chatRoomName += userCache.get(message.receiverId).name;
          } else {
            emplId = message.senderId;
            chatRoomName += userCache.get(message.senderId).name;
          }
        } else if (chatType === constants.CHANNEL_CHAT) {
          chatRoomName = message.topic;
        }

        var messageData = {
          "chatId": message.chatId,
          "topic": message.topic,
          "date": new Date(message.creTime).format("YYYY/MM/DD"),
          "img": imagePath,
          "imgAlt": sender,
          "sender": sender,
          "time": new Date(message.creTime).format("A hh:mm"),
          "msgText": message.msg,
          "chatRoomName": chatRoomName,
          "emplId": emplId
        };

        $searchListArea.append(Mustache.render(searchListTemplate, messageData));
      });
    } else {
      $searchListArea.append("<div style='text-align: center;'><span>No messages found</span></div>")
    }

    $searchListArea.nameFind("hidden-keyword").val(params["top-search"]);
  });

  setInfoSectionFlag(true);
  showInformationArea(constants.INFO_AREA_SEARCH);
}
</script>
