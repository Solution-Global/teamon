<div>
  <div class="row">
    <div class="ibox chat-view nopadding">
      <div class="ibox-content">
        <div class="content_area chat-discussion">
          <!-- // msg-template -->
          <script id="msg-template" type="text/template">
            <div class="chat-message {{mode}}" data-date="{{date}}">
              <img class="message-avatar" src="{{img}}" alt="{{imgAlt}}">
              <div class="message">
                <a class="message-author" href="#">{{sender}}</a>
                <span class="message-date">{{time}}</span>
                <span class="message-content">
                  {{{msgText}}}
                </span>
              </div>
            </div>
          </script>
          <!-- // dateline-template -->
          <script id="dateline-template" type="text/template">
            <div class="date_line">
              <span>
                <h1>{{date}}</h1>
              </span>
            </div>
          </script>
        </div>
      </div>
      <div class="ibox-footer nopadding">
        <div class="input-group">
          <div class="input-group-btn">
            <button data-toggle="dropdown" type="button" class="btn dropdown-toggle"><i class="fa fa-plus"></i></button>
            <ul class="dropdown-menu" style="top: inherit; bottom: 36px;">
              <li><a href="#" id="fileupload-btn">Upload file</a></li>
              <li><a href="#" id="capture-btn">Screen capture</a></li>
            </ul>
          </div>
          <textarea class="message-input form-control" name="message" placeholder="Enter message text"></textarea>
          <span class="input-group-btn">
            <button type="button" class="btn_send btn btn-primary">Send</button>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
<script>

  $(document).ready(function() {
    var $chatSec = $("#chat-section");
    var $contentArea = $chatSec.find('.content_area');
    var $inputText = $chatSec.find('.message-input');
    var $btnSend = $chatSec.find('.btn_send');
    var msgTemplate = $('#msg-template').html();
    var dateLineTemplate = $('#dateline-template').html();

    const MESSAGE_TYPE_APPEND = 1;
    const MESSAGE_TYPE_PREPEND = 2;
    const MENTION_FIRST_DELIMITER = "@";
    const MENTION_LAST_DELIMITER = ": ";

    $inputText.on('keyup', _keyupInputText);
    var $mentionText = $inputText.mention({
      users : [],
      firstDelimiter: MENTION_FIRST_DELIMITER,
      lastDelimiter: MENTION_LAST_DELIMITER,
      queryBy : ['username']
    });

    $contentArea.mCustomScrollbar({
      axis:"y",
      setWidth: "auto",
      theme:"3d",
      callbacks:{
        onScroll:function(){
          if(this.mcs.top === 0) {
            _getPreviousMessage(this.mcs.draggerTop);
          }
        }
      },
      scrollInertia : 0
    }).mCustomScrollbar("scrollTo", "bottom");
    $mcsbContainer = $contentArea.find('.mCSB_container'); // set this value after initing custom scrollbar

    $("#fileupload-btn").click(function() {
      openModalDialog("./fileupload_pop.html");
    });

    if(runningChannel === constants.CHANNEL_APP) {
      $("#capture-btn").click(function() {
        openModalDialog("./capture_pop.html");
      });
    }

    var _getPreviousMessage = function() {
      myMessage.getPreviousChatMessage(activeTopic.topic, function(messageArray) {
        _displayMessages(MESSAGE_TYPE_PREPEND, messageArray);
      });
    };

    var _recvMsg = function(myId, topic, payloadStr) {
      var topicArray = topic.split('/');
      if (topicArray.length < 2) {
        console.error("Invalid topic format[%s], payload:%s", topic, payloadStr);
        return;
      }

      var topicType = "/" + topicArray[1];
      if (topicType === constants.TOPIC_MSG) {
        _handleMsg(myId, payloadStr);
      } else if (topicType === constants.TOPIC_PRESENCE) {
        _handlePresence(topic, payloadStr);
      } else if (topicType === constants.TOPIC_COMMAND) {
        _handleCommand(topicArray[2], payloadStr);
      } else {
        console.error("Invalid topic format[%s], payload:", topic, payloadStr);
      }
    };

    var _handleCommand = function(receiver, payloadStr) {
      console.info("_handleCommand information %s, %s", receiver, payloadStr);

      if(receiver != myPref.emplId) {
        console.error("reciver not match %s, %s", reciver, myPref.emplId);
        return;
      }

      var commandPayload = JSON.parse(payloadStr);
      /*
        msgPayload = {
          type:  // COMMAND 타입 (client 담당)
          ...  // 각 command 타입에 따른 return value
        }
      */

      switch (commandPayload.type) {
        // group 관련
        case constants.GROUP_CREATE:
          catalogSection.displayChannel(commandPayload);
        break;
        case constants.GROUP_ADD_MEMBER:
          catalogSection.reloadChannelCache(commandPayload.channelId);
          // Active 채팅방과 멤버 추가되는 channel이 동일 할경우 asidesection에 member 추가
          if(activeTopic && activeTopic.chatRoomId === commandPayload.channelId) {
            informationSection.displayMember(commandPayload.newMembers);
          }
        break;
        case constants.GROUP_REMOVE_MEMBER:
          catalogSection.reloadChannelCache(commandPayload.channelId);

          if(myPref.emplId === commandPayload.member) {
            // 화면 닫기 & 리스트제거
            informationSection.hideSection();
            chatSection.hideSection();
            catalogSection.removeChannel(commandPayload.channelId);
            screenshareSection.hideSection();
          } else {
            if(activeTopic && activeTopic.chatRoomId === commandPayload.channelId) {
              // 사용자 제거
              informationSection.hideMember(commandPayload.member);
            }
          }
        break;
        // call 관련
        case constants.CALL_SHARE_CHID:
          callSection.setCallHistoryId(commandPayload.callHistoryId);
        break;
        default:
        console.error("invalid command[%s]", commandPayload.type);
        return;
      }
    };

    var _handleMsg = function(myId, payloadStr) {
      var msgPayload = JSON.parse(payloadStr);
      var chatType = getChatType(msgPayload.topic);
      // {"teamid":1,"publisher":13,"topic":"8_13","chatId":9,"time":1457417955367,"msg":"test"}

      // var userObj = catalogSection.getUserObj(msgPayload.publisher);
      var params = {
        senderId : msgPayload.senderid,
        chatId : msgPayload.chatid,
        msg : msgPayload.msg,
        name: "unknown",
        creTime : msgPayload.time
      };

      var message = myMessage.madeMessageUnit(params);

      if(activeTopic && activeTopic.topic  === msgPayload.topic) {
        _displayMessages(MESSAGE_TYPE_APPEND, message);
        $contentArea.mCustomScrollbar("scrollTo", "bottom");
      } else {
        setChattingAlarmCnt(chatType, msgPayload.topic);
      }

      myMessage.appendChatMessage(message, msgPayload.topic);
    };

    var _handlePresence = function(topic, payloadStr) {
      // todo : display presence info
      console.info("topic[%s], payload:", topic, payloadStr);
    };

    var _displayMessages = function(type, value) {
      var messageTags = $mcsbContainer.find(".chat-message");

      //$contentArea.mCustomScrollbar("scrollTo", "bottom");

      if(Array.isArray(value)) {
        if(MESSAGE_TYPE_APPEND === type) {
          for (var key = 0; key < value.length; key++) {
            if(value[key - 1] && value[key - 1].date != value[key].date) {
              $mcsbContainer.append(Mustache.render(dateLineTemplate, {"date" : value[key].date}));
            }
            $mcsbContainer.append(Mustache.render(msgTemplate, value[key]));
          }
          $contentArea.mCustomScrollbar("scrollTo", "bottom");
        } else {
          // prepend mode
          var firstDate = messageTags ? messageTags.first().data("date") : undefined;
          for (var key = (value.length-1); key > -1; key--) {
            $mcsbContainer.prepend(Mustache.render(msgTemplate, value[key]));

            if (key === (value.length-1)) {
              if(firstDate && value[key].date != firstDate) {
                $mcsbContainer.prepend(Mustache.render(dateLineTemplate, {"date" : value[key].date}));
              }
            } else {
              if(value[key - 1] && value[key - 1].date != value[key].date) {
                $mcsbContainer.prepend(Mustache.render(dateLineTemplate, {"date" : value[key].date}));
              }
            }
          }
        }

      } else {
        if(MESSAGE_TYPE_APPEND === type) {
          var lastDate = messageTags ? messageTags.last().data("date"): undefined;
          if(lastDate && value.date != lastDate) {
            $mcsbContainer.append(Mustache.render(dateLineTemplate, {"date" : value.date}));
          }
          $mcsbContainer.append(Mustache.render(msgTemplate, value));
          $contentArea.mCustomScrollbar("scrollTo", "bottom");
        }
      }
    };

    var _keyupInputText = function(event) {
      // mention이 활성화 되어 있으면 send 전송을 막는다.
      if (event.keyCode == 13 && event.shiftKey !== true && !$mentionText.data('mention').shown) {
        $btnSend.click();
      }
    };

    // global var
    changeChatView = function() {
      var chatType = activeTopic.chatType,
          topic = activeTopic.topic,
          chatRoomName = activeTopic.name;

      console.log("chatType:%s, topic:%s",activeTopic.chatType, activeTopic.topic);

      // remove chatting texts
      $.each($contentArea.find(".chat-message"), function(idx, row) {
        $(row).remove();
      });

      $.each($contentArea.find(".date_line"), function(idx, row) {
        $(row).remove();
      });

      hideChattingAlram(chatType, topic); // init Alram
      setHearderTitle(chatRoomName);

      // if(chatType === constants.CHANNEL_CHAT) {
      //   var channelValue = catalogSection.getChannelObj(chatRoomId);
      //   var members = []; // for mention
      //   for(var key in channelValue.memberList) {
      //     var userValue = catalogSection.getUserObj(channelValue.memberList[key].emplId);
      //
      //     //본인 제외
      //     if(userValue.emplId === myPref.emplId)
      //       continue;
      //
      //     members.push({
      //       "username" : userValue.loginId,
      //       "image": "../img/profile_img" + userValue.emplId % 10 + ".jpg"
      //     });
      //   }
      //
      //   $mentionText.mention("updateUsers", members);
      // }

      var messageArray = myMessage.getAllChatMessage(activeTopic.topic); // get previous messages
      if(messageArray) {
        _displayMessages(MESSAGE_TYPE_APPEND, messageArray);
      }
    };

    // init
    chatModule.configMyInfo(loginInfo.teamId, loginInfo.emplId, _recvMsg); // init mqtt

    // bind events
    $btnSend.on('click', function() {
      if (activeTopic.topic === undefined) {
        console.error("No peer selected!");
        return;
      }
      var msg = $inputText.val();

      if (!msg || !msg.trim().length) {
        return;
      }
      // msg = msg.replace(/\n$/, "");

      chatModule.sendMsg(activeTopic.topic, msg);
      $inputText.val("").focus();
      }
    );
  });
</script>
