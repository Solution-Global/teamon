
<div class="modal-dialog">
	<div class="modal-content animated fadeIn">
		<div class="modal-body">
      <form id="fileupload-form" class="dropzone" action="#">
        <div class="dropzone-previews"></div>
      </form>
      <div class="m text-right" style="height: 20px">
        <button id="submit-fileupload" type="submit" class="btn btn-primary pull-right">Upload profile image</button>
      </div>
    </div>
  </div>
</div>
<script>
var	dropzone = new Dropzone("#fileupload-form", {
    autoProcessQueue: false,
    uploadMultiple: true,
    parallelUploads: 10,
    maxFiles: 1,
		url: UPLOAD_URL + loginInfo.teamId + "/profile_image/" + loginInfo.emplId + "/profile",
		dictDefaultMessage: "Drop files here to upload and click below button",

    // Dropzone settings
    init: function() {
        var myDropzone = this;
        $("#submit-fileupload").click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            myDropzone.processQueue();
        });
				// FIXME multiple -> single
        this.on("sendingmultiple", function() {
          $("#submit-fileupload").attr("disabled", "disabled");
        });
        this.on("successmultiple", function(files, response) {
					$("#submit-fileupload").closest(".modal-dialog").closest(".modal").modal("hide");
          var fileNames = "";
          $.each(files, function(idx) {
						var fileArr = files[idx].name.split('.');
						var fileUrl = getImagePath(loginInfo.emplId + '.' + fileArr[1], loginInfo.teamId, loginInfo.emplId);
						var params = $(this).serializeObject();
						params.emplId = loginInfo.emplId;
						params.photoLoc = loginInfo.emplId + '.' + fileArr[1];

						restResource.empl.changeProfileImg(params,
							function(data, response) {
								// Success
								myPreference.setPreference("photoLoc", params.photoLoc);
								// TODO image cache 때문인지 사용자 chat_section과 information_section의 이미지가 바뀌지않음.
								var userValue = userCache.get(loginInfo.emplId);

								loginInfo.photoLoc = params.photoLoc;
								$("#user-profile img.chat-avatar").attr("src", fileUrl + "&timestamp=" + new Date().getTime());
								toastr.info("Your profile image has been modified successfully");
						});
          });
        });
        this.on("errormultiple", function(files, response) {
					console.error(response);
					toastr.error("Failed to upload. Please try again");
        });
    }
});
</script>
