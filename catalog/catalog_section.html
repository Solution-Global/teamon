<div class="sidebar-collapse" id="side-menu">
  <div id="topic-list">
    <ul class="nav metismenu">
      <li>
        <a class="channels-link" href="#"><i class="fa fa-hashtag"></i><span class="nav-label">Channels</span><span id="onChannelJoinModal" class="label label-info pull-right">ADD</span></a>
        <div class="chat-channels">
          <ul id="channels-list" class="nav nav-second-level">
            <script id="channel-template" type="text/template">
              <li data-channelid="{{channelId}}" data-topic="{{topic}}">
                <a href="#">{{topic}}
                  <span class="badge badge-warning right hide alarm"></span>
                </a>
              </li>
            </script>
          </ul>
        </div>
      </li>
      <li>
        <a class="users-link" href="#"><i class="fa fa-user"></i><span class="nav-label">Users</span></a>
        <div class="chat-users">
          <ul id="users-list" class="nav nav-second-level">
            <script id="user-template" type="text/template">
              <li data-topic="{{topic}}" data-name="{{name}}" data-emplid="{{emplId}}" class="chat-user">
                <a href="#">
                  <img class="chat-avatar" src="{{img}}" alt="{{imgAlt}}">
                  <div class="chat-user-name ellipsis">{{name}}
                    <span class="badge badge-warning right hide alarm"></span>
                  </div>
                </a>
              </li>
            </script>
          </ul>
        </div>
      </li>
    </ul>
  </div>
  <div class="nav-header">
    <div class="profile-element">
      <span>
      <img alt="image" src="./img/logo_uangel.png"/>
      </span>
      <div class="profile-area" id="user-profile">
        <script id="profile-template" type="text/template">
          <img class="chat-avatar" src="{{img}}" alt="{{imgAlt}}" style="border: none" />
          <div class="chat-user-name ellipsis">{{name}}</div>
        </script>
      </div>
      <div class="public-area">
        <a data-toggle="dropdown" href="#">
            <i class="fa fa-user"></i> Profile&nbsp;&nbsp;|&nbsp;&nbsp;
        </a>
        <ul class="dropdown-menu animated fadeInRight dropdown-side">
            <li><a href="#" id="onPasswordModal">Change Password</a></li>
            <li><a href="#" id="onProfileWindow">Profile Image</a></li>
        </ul>
        <a href="#" id="onLogOut"><i class="fa fa-power-off"></i> Sign-out</a>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  userCache = new cacheManager(); // user list 저장
  channelCache = new cacheManager(); // channel list 저장
  myMessage = messageManager(localStorageManager, loginInfo, userCache, channelCache); // global var

  var $userProfile = $('#user-profile');
  var $catalogSec = $("#catalog-section");
  var profileTemplate = $('#profile-template').html();
  var $userListContext = $('#users-list');
  var $channelListContext = $('#channels-list');
  var userTemplate = $('#user-template').html();
  var channeTemplate = $('#channel-template').html();
  var $userArea = $catalogSec.find('.chat-users');
  var $channelArea = $catalogSec.find('.chat-channels');

  var imagePath = getImagePath(loginInfo.photoLoc, loginInfo.teamId, loginInfo.emplId);

  // set profile
  var loginUserData = {
      "name" : loginInfo.name,
      "emplId": loginInfo.emplId,
      "img": imagePath,
      "imgAlt": loginInfo.name
  };
  console.log("constants.IMAGE_URL = %s, loginInfo.photoLoc = %s imagePath",
    constants.IMAGE_URL, loginInfo.photoLoc, imagePath);

  $userProfile.append(Mustache.render(profileTemplate, loginUserData));

  activeChatView = function($targetList, isMovingScroll){
    $channelListContext.find("li.active").removeClass("active");
    $userListContext.find("li.active").removeClass("active");

    $targetList.addClass("active");

    var topic = $targetList.data("topic");
    var chatType = getChatType(topic);
    activeChatInfo = {
      "topic" : topic
    };
    if(chatType === constants.DIRECT_CHAT) {
      activeChatInfo.name = $targetList.data("name");
      activeChatInfo.emplId = $targetList.data("emplid");
    } else {
      activeChatInfo.channelId = $targetList.data("channelid");
    }

    myPreference.setPreference("lastChatInfo", JSON.stringify(activeChatInfo)); // 마지막으로 Active한 chatting 정보 저장

    hideCallArea();
    hideScreenShareArea();

    // in small-view, hide menu
    if ($('body').hasClass('body-small'))
      $('.navbar-minimalize').click();
    else {
      if(activeChatInfo.channelId) {
        showInformationArea(constants.INFO_AREA_ABOUT_CHANNEL);
      } else {
        showInformationArea(constants.INFO_AREA_ABOUT_USER);
      }
    }

    showChatArea();
    changeChatView(isMovingScroll);
  };

  // set event for direct chatting
  $userListContext.delegate("li", "click touchend", function() {
    var $targetList = $(this);
    activeChatView($targetList, true);
  });

  // set event for group chatting
  $channelListContext.delegate("li", "click touchend", function() {
    var $targetList = $(this);
    activeChatView($targetList, true);
  });

  // init User List
  var params = {
    "teamId": loginInfo.teamId,
    "limit" : constants.COMMON_SEARCH_ALL
  };

  restResource.empl.getListByTeamId(params, function(data) {
    if (data.rows) {
      $.each(data.rows, function(idx, row) {
         userCache.set(row.emplId, row); // add each employee into userCache.

        if (row.emplId === loginInfo.emplId)
          return;

        var imgPath = getImagePath(row.photoLoc, row.teamId, row.emplId);

        var userData = {
            "topic" : generateTopic(loginInfo.emplId, row.emplId),
            "name" : row.name,
            "emplId": row.emplId,
            "img": imgPath,
            "imgAlt": row.name
        };
        $userListContext.append(Mustache.render(userTemplate, userData));
      });
      // set user count
      $("#topic-list .users-link").append(" (" + data.rows.length + ")");

      _initPresenceDisplay();
    }

    // init scroll
    $("#topic-list").mCustomScrollbar({
      axis: "y",
    });

    //sync Message
    myMessage.syncChatMessage(constants.DIRECT_CHAT, userCache.getValueArray());
  });


  // init Channel List
  params.memberIncluded = true;
  restResource.channel.getChannelList(params, function(data) {
    var channelCnt = 0;
    if(data) {
      $.each(data, function(idx, row) {
        var members;
        var isIncludingMember = false;
        for(var key in row.memberList) {
          var member = row.memberList[key];

          if(!isIncludingMember && loginInfo.emplId === member.emplId) {
            isIncludingMember = true;
          }

          if(members) {
            members += "," + member.emplId;
          } else {
            members =  member.emplId;
          }
        }

        // 본인이 속한 channel list 표시
        if(!isIncludingMember)
          return;

        channelCache.set(row.channelId, row); // add each employee into channelCache.

        var channelData = {
            "channelId": row.channelId,
            "topic": row.name,
        };
        $channelListContext.prepend(Mustache.render(channeTemplate, channelData));
        channelCnt++;
      });
      // set channel count
      $("#topic-list .channels-link").append(" (" + channelCnt + ")");
    }

    //sync Message
    myMessage.syncChatMessage(constants.CHANNEL_CHAT, channelCache.getValueArray());
    // show the last chat info
    _activeLastChatView();
  });

  var _activeLastChatView = function() {
    var lastChatInfo = myPreference.getPreference("lastChatInfo");
    var $activeTarget = null;
    if(lastChatInfo) {
      lastChatInfo = JSON.parse(lastChatInfo);
      $activeTarget = getSingleChattingContext(lastChatInfo.topic);
      $activeTarget.trigger("click");
    } else {
      // 마지막으로 저장된 chatting 정보가 없을 경우
      var channelList = channelCache.getValueArray();
      if (channelList !== null) {
        $activeTarget = getSingleChattingContext(channelList[channelList.length-1].name);
        $activeTarget.trigger("click");
      } else {
        var userList = userCache.getValueArray();
        if (userList === null) {
          hideCallArea();
          hideChatArea();
          hideScreenShareArea();
          hideInformationArea();
        } else {
          $activeTarget = getSingleChattingContext(generateTopic(loginInfo.emplId, userList[userList.length-1].emplId));
          $activeTarget.trigger("click");
        }
      }
    }
  }

  getSingleChattingContext = function (topic) {
    var chatType = getChatType(topic);
    if (chatType === constants.DIRECT_CHAT)
      return $userListContext.find("[data-topic='" + topic + "']");
    else if(chatType === constants.CHANNEL_CHAT)
      return $channelListContext.find("[data-topic='" + topic + "']");
  };

  var _initPresenceDisplay = function() {
    var params = {
      "teamId": loginInfo.teamId
    };

    restResource.login.getLoggedInEmplListByTeamId(params, function(data) {
      if(data) {
        var handleParams = {
          "status" : constants.PRESENCE_STATUS_ONLINE
        };

        $.each(data, function(idx, row) {
          handleParams.emplId = row.emplId;
          handleLoginPresence(handleParams);
        });
      }
    });
  };

  hideChattingAlram = function(topic) {
    var $activeTarget = getSingleChattingContext(topic);
    var $alarmArea = $activeTarget.find(".alarm");
    $alarmArea.addClass("hide");
    $alarmArea.html("");
  };

  setChattingAlarmCnt = function (topic, alarmCnt) {
    var $activeTarget = getSingleChattingContext(topic);
    var $alarmArea = $activeTarget.find(".alarm");
    var maxAlarmCntStr = constants.ALARM_MAX_COUNT + "+";
    if(!alarmCnt) {
      alarmCnt = $alarmArea.text();
      if(alarmCnt != maxAlarmCntStr) {
        alarmCnt = alarmCnt ? Number(alarmCnt) + 1 : 1;
      }
    }

    if(alarmCnt > constants.ALARM_MAX_COUNT)
      alarmCnt = maxAlarmCntStr;

    $alarmArea.html(alarmCnt);
    $alarmArea.removeClass("hide");
  };

  displayCreatedChannel = function(channel) {
    var params = {
      "teamId": channel.teamId,
      "name": channel.topic,
      "memberIncluded": true
    };

    restResource.channel.getChannelByName(params, function(data, response) {
      var channelData = {
        "channelId": data.channelId,
        "topic": data.name
      };
      $channelListContext.prepend(Mustache.render(channeTemplate, channelData));

      reloadChannelCache(data.channelId);
    });
  }

  removeChannel = function(channelId) {
    $channelListContext.find("[data-channelid='" + channelId + "']").remove();
    reloadChannelCache(channelId);
  }

  reloadChannelCache = function(channelId) {
    var params = {
      "channelId": channelId,
      "memberIncluded": true
    };

    restResource.channel.getChannel(params, function(data, response) {
      if(data.channelId) {
        channelCache.set(channelId, data);
      }
    });
  }

  handleLoginPresence = function(params) {
    console.log("handleLoginPresence %s", JSON.stringify(params));
    if(typeof params === 'string')
      params = JSON.parse(params);

    if(params.emplId === loginInfo.emplId) {
      return;
    }

    var topic = generateTopic(params.emplId, loginInfo.emplId)
    var $activeTarget = getSingleChattingContext(topic);
    var $profileImage = $activeTarget.find(".chat-avatar");

    if(params.status === constants.PRESENCE_STATUS_ONLINE) {
      // online
      $profileImage.addClass("online");
    } else {
      // offline
      $profileImage.removeClass("online");
    }
  };

  // bind Event
  $('#onPasswordModal').bind("click", function() {
    openModalDialog("/catalog/password_modify_popup.html");
  });

  $('#onProfileWindow').bind("click", function() {
    openModalDialog("/catalog/profile_image_popup.html");
  });

  $('#onChannelJoinModal').bind("click", function() {
    openModalDialog("/catalog/channel_join_popup.html");
  });

  $('#onLogOut').bind("click", function() {
    var dialogOptions = {
      backdrop : "static",
      keyboard : "false",
      backgroundOpacity : 1,
      backgroundColor : "#2f4050"
    };

    restResource.login.logout(loginInfo, function(data, response) {
      // logout from all devices
      console.log("loginCnt = %s", data.loginCnt);
      if (data.loginCnt == 0) {
        chatModule.logoutPublish();
      }
      // mqtt finalize
      chatModule.finalize();
    });

    // cache clear
    channelCache.initCache();
    userCache.initCache();
    loginInfo = null;

    openModalDialog("./user/login_popup.html", dialogOptions);
    //TODO session, close chat and call disconnection
    localStorageManager.removeKey("keepEmplId");
    sessionStorageManager.removeKey("sessionEmplId");
  });
});
</script>
